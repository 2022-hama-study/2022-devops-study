# 도커 정리

# 3장 컨테이너를 다루는 표준 아키텍처, 쿠버네티스

## 요약정리

---

## 3.1 쿠버네티스 이해하기

**컨테이너란?** 

하나 이상의 목적을 위해 독립적으로 작동하는 프로세스.

**컨테이너 환경이란?**

리눅스 운영 체제의 커널 하나에서 여러 개의 컨테이너가 격리된 상태로 실행되는 인프라 환경.

**왜 사용하는가?**

- 다수의 관리자가 많은 서버를 함께 관리할 때 서버 환경의 일관성을 유지하기 위해.
- 효율적인 자원 활용과 속도를 위해.

**어쩌다 등장했나?**

- 컨테이너의 도입으로 늘어난 컨테이너를 관리하기 위해.
- 기존에도 컨테이너 관리 솔루션이 있었으나 보편화되진 않았음. 구글이 오픈소스로 쿠버네티스를 공개한 이후 보편화 됨.

### 3.1.1 왜 쿠버네티스인가?

**쿠버네티스란?**

- 컨테이너 오케스트레이션을 위한 솔루션.
- 오케스트레이션: 복잡한 단계를 관리하고 요소들의 유기적인 관계를 미리 정의해 쉽게 사용하도록 서비스를 제공하는 것.
- 다수의 컨테이너를 유기적으로 연결, 실행, 종료
- 상태를 추적, 보존하는 등

⇒ 여러 서비스가 있으나 안정성, 확장성 등을 사유로 쿠버네티스가 평정 중. 다양한 종류의 솔루션이 쿠버네티스에 통합되고 있다.

### 3.1.2 쿠버네티스 구성방법

**쿠버네티스의 구성 방법 종류 3가지**

1. 관리형 쿠버네티스
- 구성이 다 갖춰져 있음. 노드를 클라우드에서 관리.
- EKS(Amazon Elastic Kubernetes Service), AKS(Azure Kubernetes Services), GKE(Google Kubernetes Engine)
1. 설치형 쿠버네티스
- 유료! 플랫폼에서 제공.
- 수세의 Rancher, 레드햇의 OpenShift
1. 구성형 쿠버네티스
- 사용하는 시스템에 쿠버네티스 클러스터를 자동으로 구성.
- 내가 알아서 구성하고 유지해야 함.
- kubeadm, kops(Kubernetes Operations), KRIB, kubespray
- kubeadm이 제일 많이 쓰인다.

### 3.1.3 쿠버네티스 구성하기

Vagrantfile: 베이그런트 프로비저닝을 위한 정보를 담고 있는 메인 파일. 여기에 정의된 가상 머신들을 생성하고, 생성한 가상 머신에 쿠버네티스 클러스터를 구성하기 위한 파일들을 호출, 클러스터를 자동으로 구성함.

**쿠버네티스 클러스터?**

- 컨테이너화된 애플리케이션을 실행하는 ’노드’라고 하는 워커 머신의 집합.
- 모든 클러스터는 최소 1개 이상의 워커 노드를 가짐.

**워커 노드?**

- 워커 노드는 애플리케이션의 구성요소인 파드를 호스트함.

**파드Pods?**

- 클러스터에서 실행 중인 컨테이너의 집합.

⇒ 쿠버네티스 클러스터는 최소 1개 이상의 워커 노드(컨테이너 집합)를 가지는 워커 머신의 집합.

### 3.1.4 파드 배포를 중심으로 쿠버네티스 구성 요소 살펴보기

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/2753b6cf-0b47-4f2c-8824-05713fa916bf/Untitled.png)

**마스터 노드**

- kubectl: 쿠버네티스 클러스터에 명령을 내리는 역할. 통상적으로 API 서버와 자주 통신하기 때문에 보통 API 서버가 위치한 마스터 노드에 구성함.
- API 서버: 쿠버네티스 클러스터의 중심 역할을 하는 통로. etcd와 통신하며 노드간 상황을 전달하고 관리함.
- etcd: 구성요소들의 상태 값이 모두 저장되는 곳!!! etcd 외의 다른 구성 요소는 상태 값을 관리하지 않음.
- 컨트롤러 매니저: 오브젝트의 상태를 관리. 상태 체크와 복구는 매니저에 속한 노드 컨트롤러에서 이루어짐.
- 스케줄러: 노드의 상태, 자원 등을 고려해 pods를 어떤 워커 노드에 생성할 것인가 결정하고 할당함.

**워커노드**

- kubelet: 파드의 구성내용(PodSpec)을 받아 런타임으로 전달하고, 파드 내 컨테이너들의 정상 작동을 모니터링 함.
- 컨테이너 런타임: 파드를 이루는 컨테이너의 실행을 담당함.
- 파드(pods): 한 개 이상의 컨테이너로 단일 목적을 수행하기 위해 구성된 최소 단위.

**사용자가 배포된 pods에 접속할 때의 과정**

- kube-proxy: pods가 통신할 수 있는 네트워크 설정. 실제 통신은 br_netfilter와 iptables로 기능.
- pods: 이미 배포된 파드에 접속하고… 필요한 내용 전달받음.

네트워크 플러그인, CoreDNS는 선택 가능한 구성 요소다. 파드의 생성/삭제 등이 어떻게 구성되는지 보면 구조가 좀 더 이해가 됨…

### 3.1.5 파드의 생명주기로 쿠버네티스 구성 요소 살펴보기

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/03e4b530-b4f8-4605-9709-2dccc6908d06/Untitled.png)

파란 네모가 마스터노드. 그 외게 워커 노드.

1. kubectl을 통해 API 서버에 pods 생성 요청
2. API 서버는 etcd에 전달된 내용을 모두 기록. 업데이트 때마다 각 요소의 상태 값이 전부 API 서버를 통해 etcd에 기록됨.
3. API 서버에 파드 생성이 요청된 것을 컨트롤러 매니저가 인지. 컨트롤러 매니저가 pods 생성.
4. pods 생성을 스케줄러가 인지. 스케줄러는 생성된 pods를 어느 워커노드에 넣을 것인가 결정하고 해당 워커 노드에 pods를 띄우도록 요청(스케줄링).
5. 요청대로 스케쥴러가 kubelet을 통해… 워커 노드에 파드가 제대로 소속됐는지 확인. 
6. kubelet에서 컨테이너 런타임으로 파드 생성을 요청. 
7. pods 생성
8. pods 사용 가능!

**쿠버네티스 구조의 특징: Desired status**

- 선언적 시스템. 작업을 순서대로 진행하는 구조가 아님. 원하는 상태를 선언하면 즉시 다른 시스템의 구성요소들이 해당 상태 조건에 자기들이 충족되는지 확인하고 그 조건을 맞추기 위해 작동함.
- 그래서 etcd의 상태값 기록이 중요한 것… API 서버는 etcd와 거의 한 몸처럼 움직임.
- 단, 워커 노드는 워크플로 방식. kubelet과 컨테이너 런타임을 통해 파드가 생성되고 삭제되는 구조라 선언적으로 움직이기에는 무리가 있기 때문에.

### 3.1.6 쿠버네티스 구성 요소의 기능 검증하기

⇒ kubectl은 어떤 노드에 있어도 정상 작동 가능함. 단, kubelet에 이상이 생기면 pods가 정상적으로 관리되지 못함.

## 3.2 쿠버네티스 기본 사용법 배우기

### 3.2.1 파드를 생성하는 방법

**kubectl run nginx-pod —image=nginx**

- 단일 pod 1개만 생성되고 관리됨.

**kubectl create deployment dpy-nginx —image=nginx**

- 디플로이먼트 관리그룹 내에 pod 생성.

### 3.2.2 오브젝트란?

**오브젝트**

- 쿠버네티스에서 클러스터의 상태를 나타내기 위해 사용함. “의도를 가진 기록”.
    - 어떤 컨테이너화된 애플리케이션이 동작 중인지 (그리고 어느 노드에서 동작 중인지)
    - 그 애플리케이션이 이용할 수 있는 리소스
    - 그 애플리케이션이 어떻게 재구동 정책, 업그레이드, 그리고 내고장성과 같은 것에 동작해야 하는지에 대한 정책
- spec과 status를 보유.

**기본 오브젝트**

- 파드
- 네임스페이스
- 볼륨
- 서비스

**추가 오브젝트**

- 디플로이먼트
- 레플리카

### 3.2.3 레플리카셋으로 파드 수 관리하기

**레플리카셋?**

- 기술한 만큼 복수의 pods를 생성.

### 3.2.4 스펙을 지정해 오브젝트 생성하기

**Spec**

- 오브젝트 생성 시 의도한 상태
- spec 을 가진 오브젝트는 **오브젝트를 생성할 때 리소스에 원하는 특징(의도한 상태)에 대한 설명을 제공해서 설정**

### 3.2.5 apply로 오브젝트 생성하고 관리하기

apply 커맨드를 사용하면 .yaml 파일에 기술한 spec을 가진 오브젝트 생성 가능.

### 3.2.6 파드의 컨테이너 자동 복구 방법

### 3.2.7 파드의 동작 보증 기능

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/10a6425c-9046-42a7-90b9-73465b1982df/Untitled.png)

### 3.2.8 노드 자원 보호하기

### 3.2.9 노드 유지보수하기

### 3.2.10 파드 업데이트 및 복구

## 3.3 쿠버네티스 연결을 담당하는 서비스

### 3.3.1 노드포트

### 3.3.2 사용 목적별로 연결하는 인그레스

### 3.3.3 클라우드에서 쉽게 구성 가능한 로드 밸런서

### 3.3.4 온프레미스에서 로드밸런서를 제공하는 MetalLB

### 3.3.5 부하에 따라 자동으로 파드 수를 조절하는 HPA

## 3.4 알아두면 쓸모있는 쿠버네티스 오브젝트

### 3.4.1 데몬셋

### 3.4.2 컨피그맵

### 3.4.3 PV와 PVC

### 3.3.4 스테이트풀셋

---

## 개인 감상

아! 너무너무 어렵다! 몰아서 해치우지 말자!

거시적인 아키텍처 관점에서의 설명.

도커 컨테이너를 공부하고 다시 돌아와서 보면 더 이해가 될 듯 하다.